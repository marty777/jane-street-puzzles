# https://www.janestreet.com/puzzles/some-ones-somewhere-index/

from copy import deepcopy

DIM = 45
N = 9

BOARD1 = """
000000000004444999999999999999999444488888888
000000000004444999999999999999999444488888888
000000000004444999999999999999999444488888888
000000000004444999999999999999999444488888888
000000000000333999999999999999999444488888888
000000000000333999999999999999999444488888888
000000000000333999999999999999999444488888888
000000000000000999999999999999999444488888888
000000000000000999999999999999999555557777777
999999999000000000000000000000000555557777777
999999999000000000000000000000000555557777777
999999999000000000000000000000000555557777777
999999999000000000000000000000000555557777777
999999999666666000000000000009999999997777777
999999999666666000000000000009999999997777777
999999999666666000000000000009999999997777777
999999999666666000000000000009999999997777777
999999999666666000000000000009999999997777777
999999999666666000000000000009999999997777777
999999999555550000000000000009999999997777777
999999999555550000000000000009999999997777777
999999999555550000000000000009999999997777777
999999999555550000000000000000000000088888888
999999999555550000000000000000000000088888888
999999999555550000000000000000000000088888888
999999999555550000000000000000000000088888888
999999999555550000000000000000000000088888888
999999999555550000000000000000000000088888888
999999999555550000000000000000000000088888888
999999999888888880000000000000000000088888888
999999999888888880000000000008888888888888888
999999999888888880000000000008888888888888888
999999999888888880000000000008888888888888888
999999999888888880000000000008888888888888888
999999999888888880000000000008888888888888888
999999999888888880000000000008888888888888888
999999999888888880000000000008888888888888888
999999999888888880000000000008888888888888888
999999999888888880000000000000077777777777777
999999999888888880000000000000077777777777777
999999999888888880000000000000077777777777777
999999999888888880000000000000077777777777777
999999999888888880000000000000077777777777777
999999999888888880000000000000077777777777777
999999999888888880000000000000077777777777777
"""

BOARD2 = """
444444444444777777777777776666668888888855555
444444444444777777777777776666668888888855555
444444444444777777777777776666668888888855555
444444444444777777777777776666668888888855555
999999999333777777777777776666668888888855555
999999999333777777777777776666668888888855555
999999999333777777777777770000008888888855555
999999999000000000000000000000008888888855555
999999999000000000000000000000000000000055555
999999999000000000000000000000000000000055555
999999999000000000000000000000000000999999999
999999999000000000000000000000000000999999999
999999999000000000000000000000000000999999999
000000000000000000000000000000000000999999999
000000000000000000000000000000000000999999999
000000000000000000000000000000000000999999999
000000000000000000000000000000000000999999999
000000000000000000000000000000000000999999999
000000000000000000000000000000000000999999999
000000000000000000000000000999999999999999999
000000000000000000000000000999999999999999999
000000000000000000000000000999999999999999999
000000000000000000000000000999999999999999999
000000000000000000000000000999999999999999999
000000000000000055555000000999999999999999999
000000000000000055555333000999999999999999999
000000000000000055555333000999999999999999999
000000000000000055555333000999999999999999999
000000000000000055555888888888888888888888888
777777777777777777777888888888888888888888888
777777777777777777777888888888888888888888888
777777777777777777777888888888888888888888888
777777777777777777777888888888888888888888888
777777777777777777777888888888888888888888888
777777777777777777777888888888888888888888888
777777777777777777777888888888888888888888888
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
"""

BOARD3 = """
999999999888888889999999995555500000999999999
999999999888888889999999995555500000999999999
999999999888888889999999995555500000999999999
999999999888888889999999995555500000999999999
999999999888888889999999995555500000999999999
999999999888888889999999994444220000999999999
999999999888888889999999994444220000999999999
999999999888888889999999994444000000999999999
999999999888888889999999994444000000999999999
999999999888888887777777000000000000000000000
999999999888888887777777000000000000000000000
999999999888888887777777000000000000000000000
999999999888888887777777000000000000000000000
999999999888888887777777000000000000000000000
999999999888888887777777000000000000000000000
999999999888888887777777000000066666600000000
999999999777777700000000000000066666600000000
999999999777777700000000000000066666688888888
999999999777777700000000000000066666688888888
999999999777777700000000000000066666688888888
999999999777777700000000000000066666688888888
999999999777777700000000000000066666688888888
999999999777777700000000000000066666688888888
999999999000000000000000000000066666688888888
999999999000000000000000000033366666688888888
999999999000000000000000000033366666688888888
999999999000000000000000000033366666688888888
999999999000000000000000000099999999988888888
999999999000000000000000000099999999988888888
999999999000000000003335555599999999988888888
999999999000000000003335555599999999988888888
999999999000000000003335555599999999988888888
999999999000000077777775555599999999988888888
999999999000000077777775555599999999988888888
999999999000000077777775555599999999988888888
999999999000000077777775555599999999988888888
999999999000000077777775555599999999988888888
999999999000000077777775555599999999988888888
999999999777777777777775555599999999988888888
999999999777777766666666666699999999988888888
999999999777777766666666666699999999988888888
999999999777777766666666666699999999944444444
999999999777777766666666666699999999944444444
999999999777777766666666666699999999944444444
999999999777777766666666666699999999944444444
"""

BOARD4 = """
999999999999999999666666000000077777777777777
999999999999999999666666000000077777777777777
999999999999999999666666000000077777777777777
999999999999999999666666000000077777777777777
999999999999999999666666000000077777777777777
999999999999999999666666000000077777777777777
999999999999999999666666000000077777777777777
999999999999999999666666000000000000088888888
999999999999999999666666000000000000088888888
888888887777777333666666000000000000088888888
888888887777777333666666000000000000088888888
888888887777777333666666000000000000088888888
888888887777777000000000000000000000088888888
888888887777777000000000000000000000088888888
888888887777777000000000000000000000088888888
888888887777777000000000000000000444488888888
888888884444000000000000000000000444488888888
555553334444000000000000000000000444488888888
555553334444000000000000000000000444488888888
555553334444000000000000000099999999988888888
555557777777000000000000000099999999988888888
555557777777000000000000000099999999988888888
555557777777000000000000000099999999988888888
555557777777000000000000000099999999988888888
555557777777000000000000000099999999988888888
555557777777000000000000000099999999988888888
555557777777000000000000000099999999988888888
999999999000000000000000000099999999988888888
999999999000000000000000000000005555588888888
999999999000000000000000000000005555588888888
999999999000000000000000000000005555588888888
999999999000000000000000000000005555588888888
999999999000000000000000000000005555588888888
999999999000000000000000000000000002288888888
999999999000000000000000000000000002288888888
999999999000000000000000000000000444488888888
999999999999999999999999999000000444488888888
999999999999999999999999999000000444488888888
999999999999999999999999999000000444488888888
999999999999999999999999999000000666666666666
999999999999999999999999999000000666666666666
999999999999999999999999999000000666666666666
999999999999999999999999999000000666666666666
999999999999999999999999999000000666666666666
999999999999999999999999999000000666666666666
"""

BOARD5 = """
000000000000000000000077777777777777999999999
000000000000000000000077777777777777999999999
444400000000000000000077777777777777999999999
444400000000000000000077777777777777999999999
444400000000000000000077777777777777999999999
444400000000000000000077777777777777999999999
777777755555555550000077777777777777999999999
777777755555555550000000000000055555999999999
777777755555555550000000000000055555999999999
777777755555555550000000000000055555000000000
777777755555555550000000000000055555000000000
777777799999999900000000000000055555000000000
777777799999999900000000000000000000000000333
777777799999999900000000000000000000000000333
777777799999999900000000000000000000000000333
777777799999999900000000000000000000000666666
777777799999999900000000000000000000000666666
777777799999999900000000000000000000000666666
777777799999999900000000000000000000000666666
777777799999999900000000000000000000000666666
888888888888888800000000000000000000000666666
888888888888888800000000000000000000088888888
888888888888888800000000000000000000088888888
888888888888888800000000000000000000088888888
888888888888888800000000000000000000088888888
888888888888888800000000000000000444488888888
888888888888888800000000000000000444488888888
888888888888888800000000000000000444488888888
888888888888888888888888000000000444488888888
888888888888888888888888000000077777777777777
888888888888888888888888000000077777777777777
888888888888888888888888000000077777777777777
888888888888888888888888000000077777777777777
888888888888888888888888000000077777777777777
888888888888888888888888000000077777777777777
888888888888888888888888000000077777777777777
999999999999999999000000000000000000999999999
999999999999999999000000000000000000999999999
999999999999999999000000000000000000999999999
999999999999999999000000000000000000999999999
999999999999999999000000000000000000999999999
999999999999999999000000000000000000999999999
999999999999999999000000000000000000999999999
999999999999999999000000000000000000999999999
999999999999999999000000000000000000999999999
"""


BOARD6 = """
999999999444444447777777777777777777777777777
999999999444444447777777777777777777777777777
999999999444444447777777777777777777777777777
999999999444444447777777777777777777777777777
999999999000000007777777777777777777777777777
999999999000000007777777777777777777777777777
999999999000000007777777777777777777777777777
999999999000000000000000088888888666666666666
999999999000000000000000088888888666666666666
999999999000000000000000088888888666666666666
999999999000000000000000088888888666666666666
999999999000000000000000088888888666666666666
999999999000000000000000088888888666666666666
999999999000000000000000088888888000999999999
999999999000000000000000088888888000999999999
999999999000000000000000000000000000999999999
999999999000000000000000000000000000999999999
999999999000000000000000000000000000999999999
999999999000000000000000000000000000999999999
999999999000000000000000000000000000999999999
999999999000000000000000000000000022999999999
999999999000000000000000000000000022999999999
999999999000000000000000000000007777777666666
999999999000000000000000000000007777777666666
999999999000000000000000000000007777777666666
999999999000000000000000000000007777777666666
999999999333000000000000000000007777777666666
999999999333000000000000000000007777777666666
999999999333000000000000000000007777777666666
999999999888888887777777000000000000000666666
999999999888888887777777000000000000000666666
999999999888888887777777000000000000000666666
999999999888888887777777000000000000000666666
999999999888888887777777000000000000000666666
999999999888888887777777000000000000000666666
999999999888888887777777000000000000000666666
999999999888888889999999990000000000000666666
999999999888888889999999990000000000000666666
999999999888888889999999990000000000000666666
999999999888888889999999990000000000000666666
999999999888888889999999990000000005555555555
999999999888888889999999990000000005555555555
999999999888888889999999990000000005555555555
999999999888888889999999990000000005555555555
999999999888888889999999990000000005555555555
"""

BOARD7 = """
999999999777777700000066666699999999988888888
999999999777777700000066666699999999988888888
999999999777777700000066666699999999988888888
999999999777777700000066666699999999988888888
999999999777777700000066666699999999988888888
999999999777777700000066666699999999988888888
999999999777777700000000000099999999988888888
999999999888888880000000000099999999988888888
999999999888888880000000000099999999900000000
999999999888888880000000000000000000000000000
999999999888888880000000000000000000000000000
999999999888888880000000000000000000000000000
999999999888888883330000000000000000000000000
999999999888888883330000000000000000000000000
999999999888888883330000000000000000000000000
999999999777777777777770000000000000000000000
999999999777777777777770000000000000000004444
999999999777777777777770000000000000000004444
999999999777777777777770000000000000000004444
999999999777777777777770000000000000000004444
999999999777777777777770000000000000088888888
999999999777777777777770000000000000088888888
999999999777777700000000000000000000088888888
999999999777777700000000000000000000088888888
999999999777777700000000000000000000088888888
999999999777777700000000000000000000088888888
999999999777777700000000000000000000088888888
999999999777777700000000000000000000088888888
999999999777777700000000000000000000088888888
999999999888888887777777000000000000088888888
999999999888888887777777000000000000088888888
999999999888888887777777000000000000088888888
999999999888888887777777000000000000088888888
999999999888888887777777000000000000088888888
999999999888888887777777000000000000088888888
999999999888888887777777000000000000088888888
999999999888888889999999994444000000999999999
999999999888888889999999994444000000999999999
999999999888888889999999994444000022999999999
999999999888888889999999994444000022999999999
999999999888888889999999995555555555999999999
999999999888888889999999995555555555999999999
999999999888888889999999995555555555999999999
999999999888888889999999995555555555999999999
999999999888888889999999995555555555999999999
"""

BOARD8 = """
999999999999999999999999999444455555999999999
999999999999999999999999999444455555999999999
999999999999999999999999999444455555999999999
999999999999999999999999999444455555999999999
999999999999999999999999999000055555999999999
999999999999999999999999999000000022999999999
999999999999999999999999999000000022999999999
999999999999999999999999999000000000999999999
999999999999999999999999999000000000999999999
999999999777777766666655555000000000007777777
999999999777777766666655555000000000007777777
999999999777777766666655555000000000007777777
999999999777777766666655555000000000007777777
999999999777777766666655555000000000007777777
999999999777777766666677777770000000007777777
999999999777777766666677777770000000007777777
999999999777777766666677777770000000007777777
999999999777777766666677777770000000007777777
999999999777777766666677777770000000007777777
999999999777777766666677777770000000007777777
999999999777777766666677777770000000007777777
999999999777777788888888000000000000007777777
999999999777777788888888000000000000007777777
999999999000000088888888000000000000088888888
999999999000000088888888000000000000088888888
999999999000000088888888000000000000088888888
999999999000000088888888000000000000088888888
999999999000000088888888000000000000088888888
999999999000000088888888000000000000088888888
999999999000000000000000000000000000088888888
999999999000000000000000000000000000088888888
999999999000000000000000000000000000000000000
999999999000000000000000000000000000000000000
999999999000000000000000000000000000000000000
999999999000000000000000000000000000000000333
999999999000000000000000000000000000000000333
000000000000000000000000000000000000000000333
000000000000000000000000000008888888888888888
000000000000000000000000000008888888888888888
000000000000000000000000000008888888888888888
000000000000000000000000000008888888888888888
000000000000000000000000044448888888888888888
000000000000000000000000044448888888888888888
000000000000000000000000044448888888888888888
000000000000000000000000044448888888888888888
"""

BOARD9 = """
666666666666666666555554444000000000000000000
666666666666666666555554444000000000000000000
666666666666666666555554444000000000000000000
666666666666666666555554444000000000000000000
666666666666666666555550000000000000000000000
666666666666666666000000000000000000000000000
888888888888888800000000000000000000000000000
888888888888888800000000000000000000000000000
888888888888888800000000000000000000000000000
888888888888888800000000000000000000000000000
888888888888888800000000000000000000000000000
888888888888888800000000000000000000000000000
888888888888888800000000000000000000000000000
888888888888888800000000000000000000000000000
000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000
000000000000000000000000000000000000000000000
000000000000000000000000000000000000999999999
000000000000000000000000000000000000999999999
000000000000000000000000000000000000999999999
000000000000000000000000777777755555999999999
777777700000000000000000777777755555999999999
777777700000000000000000777777755555999999999
777777700000000000004444777777755555999999999
777777733300000000004444777777755555999999999
777777733300000000004444777777755555999999999
777777733300000000004444777777755555999999999
777777788888888888888888888888855555999999999
777777788888888888888888888888855555999999999
777777788888888888888888888888855555999999999
777777788888888888888888888888855555999999999
777777788888888888888888888888855555999999999
777777788888888888888888888888855555999999999
777777788888888888888888888888855555999999999
777777788888888888888888888888855555999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
999999999999999999999999999999999999999999999
"""

BOARDS = [BOARD1, BOARD2, BOARD3, BOARD4, BOARD5, BOARD6, BOARD7, BOARD8, BOARD9]

class Piece:
    def __init__(self, size, pos):
        self.size = size
        self.pos = pos

class PartialBoard:
    def __init__(self, board_string):
        self.pieces = []
        board_temp = []
        board_lines = board_string.splitlines()
        for line in board_lines:
            if len(line.strip()) == 0:
                continue
            row = list(map(lambda x: int(x), list((line.strip()))))
            board_temp.append(row)
        while True:
            found = False
            for y in range(DIM):
                for x in range(DIM):
                    pos = (x,y)
                    if board_temp[y][x] != 0:
                        size = board_temp[y][x]
                        found = True
                        for y1 in range(size):
                            for x1 in range(size):
                                if board_temp[y + y1][x + x1] != size:
                                    print(f"Board error: piece at pos {pos} of size {size} has an unexpected entry at position {x+x1},{y+y1}: {board_temp[y + y1][x + x1]}")
                                    return
                                board_temp[y + y1][x + x1] = 0
                        self.pieces.append(Piece(size, pos))
                    if found:
                        break
                if found:
                    break
            if not found:
                break

    # Solve the partial partridge puzzle using a breadth-first search
    def solve(self):
        candidates = []
        next_candidates = []
        next_candidates.append(self.pieces)
        successes = []
        while len(next_candidates) > 0:
            candidates = next_candidates
            next_candidates = []
            while len(candidates) > 0:
                candidate = candidates.pop()
                temp_board = []
                temp_total = 0
                temp_piece_count = [0] * (N+1)
                for y in range(DIM):
                    temp_board.append([0] * DIM)
                for i in range(len(candidate)):
                    temp_piece_count[candidate[i].size] += 1
                    temp_total += candidate[i].size * candidate[i].size
                    for y1 in range(candidate[i].size):
                        for x1 in range(candidate[i].size):
                            temp_board[candidate[i].pos[1] + y1][candidate[i].pos[0] + x1] = candidate[i].size
                if temp_total == DIM * DIM:
                    successes.append(candidate)
                    continue
                # Locate the first unfilled position and try all available 
                # pieces that will fit
                empty_pos = None
                for y in range(DIM):
                    for x in range(DIM):
                        if temp_board[y][x] == 0:
                            empty_pos = (x,y)
                        if empty_pos != None:
                            break
                    if empty_pos != None:
                        break
                assert empty_pos != None, f"Empty pos from candidate {candidate}"
                for size in range(1,N+1):
                    if temp_piece_count[size] >= size:
                        continue
                    size_okay = True
                    for y1 in range(size):
                        for x1 in range(size): 
                            if empty_pos[1] + y1 >= DIM or empty_pos[0] + x1 >= DIM:
                                size_okay = False
                                break 
                            if temp_board[empty_pos[1] + y1][empty_pos[0] + x1] != 0:
                                size_okay = False
                                break
                        if not size_okay:
                            break
                    if size_okay:
                        next_candidate = deepcopy(candidate)
                        next_candidate.append(Piece(size, empty_pos))
                        next_candidates.append(next_candidate)
        # Require there to be a unique solution to the board and return the 
        # position of the 1-tile within it
        one_coord = None
        if len(successes) != 1:
            return None
        for i in range(len(successes[0])):
            if successes[0][i].size == 1:
                return successes[0][i].pos
        return None

def main():
    print("####### Janestreet Puzzle - June 2025 #######\n")
    # Solve each of the 9 partridge puzzles and collect the position of the 
    # 1-tile for each
    one_tiles = []
    for i in range(len(BOARDS)):
        board = PartialBoard(BOARDS[i])
        print(f"Solving board {i+1}...")
        one_tiles.append(board.solve())
    
    # Take the position the 1-tile in each solution, map them onto a 135x135
    # grid composed of each partridge puzzle, take the x and y coords mod 26 
    # and map them onto the alphabet to find the letters of the solution 
    # phrase
    phrase = ''
    print("\n1-tile coordinates mapped to letters:")
    for i in range(9):
        tile = one_tiles[i]
        x_offset = (i % 3) * DIM
        y_offset = (i // 3) * DIM
        x_coord = x_offset + tile[0]
        y_coord = y_offset + tile[1]
        a = chr(65 + (y_coord % 26))
        b = chr(65 + (x_coord % 26))
        print(f"{a}{b} ", end='')
        if i % 3 == 2:
            print()
        phrase += f"{a}{b}"
    print(f"\nSolution: THE {phrase[:3]} {phrase[3:5]} {phrase[5:10]} {phrase[10:12]} A {phrase[12:]}")

if __name__ == "__main__":
    main()